# Deep Security Amazon GuardDuty Integration

An AWS Lambda function to create a joint workflow between Amazon GuardDuty and Deep Security.


## Table of Contents

* [Architecture](#architecture)
* [Setup](#setup)
* [Test](#test)
* [Support](#support)
* [Contribute](#contribute)


## Architecture

Here's the general workflow of each of these services:

![General Workflow](https://github.com/deep-security/amazon-guardduty/blob/master/docs/general-workflow.png?raw=true "General Trend Micro Deep Security and Amazon GuardDuty workflows")

Combined together, Deep Security can use the intelligence and insight generated by Amazon GuardDuty to make better decisions about the security of your Amazon EC2 instances and Amazon ECS hosts.

![Integrated Workflow](https://github.com/deep-security/amazon-guardduty/blob/master/docs/integrated-workflow.png?raw=true "Integrated Trend Micro Deep Security and Amazon GuardDuty workflow")

### Findings

This integration supports workflows for these findings:

- **Recon:EC2/PortProbeUnprotectedPort**, **Recon:EC2/Portscan**, **Behavior:EC2/NetworkPortUnusual**, or **Behavior:EC2/TrafficVolumeUnusual** when any of these findings are raised:
	- Deep Security will run a recommendation scan to ensure the instance has an appropriate security policy
	- If requested, Deep Security will also enable intrusion prevention on the instance if it isn't already active

- **Recon:EC2/Portscan** when this finding is raised:
	- Deep Security will run a recommendation scan to ensure the instance has an appropriate security policy
	- If requested, Deep Security will also enable intrusion prevention on the instance if it isn't already active

- **UnauthorizedAccess:EC2/MaliciousIPCaller.Custom** or **UnauthorizedAccess:EC2/TorIPCaller** when either of these findings are raised:
	- Deep Security will run a recommendation scan to ensure the instance has an appropriate security policy
	- Deep Security will run an integrity scan to ensure that critical files have not changed
	- Deep Security will run a malware scan to look for infections or malicious activity
	- If requested, Deep Security will also enable intrusion prevention on the instance if it isn't already active

- **UnauthorizedAccess:EC2/SSHBruteForce** or **UnauthorizedAccess:EC2/RDPBruteForce** when either of these findings are raised:
	- Deep Security will run a recommendation scan to ensure the instance has an appropriate security policy
	- Deep Security will run an integrity scan to ensure that critical files have not changed
	- If requested, Deep Security will also enable intrusion prevention and integrity monitoring on the instance if it isn't already active

- **CryptoCurrency:\*** when any of these findings are raised:
	- Deep Security will run a malware scan to ensure the instance hasn't been infected
	- If requested, Deep Security will also enable anti-malware on the instance if it isn't already active

- **Backdoor:EC2\*** when any of these findings are raised:
	- Deep Security will run a malware scan to ensure the instance hasn't been infected
	- Deep Security will run an integrity scan to ensure that critical files have not changed
	- If requested, Deep Security will also enable anti-malware on the instance if it isn't already active
	- Deep Security will not enable integrity monitoring because the instance may already be compromised, it will simply run a scan if integrity monitoring is already enable to detect any changes to critical files

- **Trojan:EC2\*** when any of these findings are raised:
	- Deep Security will run a malware scan to ensure the instance hasn't been infected
	- Deep Security will run an integrity scan to ensure that critical files have not changed
	- If requested, Deep Security will also enable anti-malware on the instance if it isn't already active
	- Deep Security will not enable integrity monitoring because the instance may already be compromised, it will simply run a scan if integrity monitoring is already enable to detect any changes to critical files
 

### Policies in Deep Security

Deep Security uses policies to apply security controls and configurations to your EC2 instances and ECS hosts. These policies allow fine-grained control over the protection that Deep Security applies.

In most cases, you don't need to dive into the specifics. The Deep Security Anti-Malware and Web Reputation controls are basically "set and forget". The Deep Security Firewall is not required within AWS because Security Groups can be used instead, although you still may want a unified firewall across all environments or to leverage its advanced logging capabilities. 

Using recommendation scans, you can automatically apply appropriate Deep Security Intrusion Prevention, Integrity Monitoring, and Log Inspection settings. It is [**strongly recommended**](https://help.deepsecurity.trendmicro.com/best-practice-guide.html) that you implement this feature. For your Base Policy (or any policy), simply select each of the modules on their details page.

![Automatically Implement Rule Recommendations](https://github.com/deep-security/amazon-guardduty/blob/master/docs/ds-automatically-apply-rules.png?raw=true "Automatically implement rule recommendations (when possible)")

[Application control can also be used](https://help.deepsecurity.trendmicro.com/Protection-Modules/Application-Control/detect-drift.html), but should be built into your CI/CD work flow instead. 

## Setup

To use the integration, you must configure both Deep Security and AWS.

### Create a User in Deep Security

During execution, the AWS Lambda functions will query the Deep Security API. To do this, they require a Deep Security login with permissions.

You should set up a dedicated use account for API access. To configure the account with the minimum privileges (which reduces the risk if the credentials are exposed) required by this integration, follow the steps below.

1. In Deep Security, go to *Administration > User Manager > Roles*. 
1. Click **New**. Create a new role with a unique, meaningful name.
1. Under **Access Type**, select **Allow Access to web services API**.
1. Under **Access Type**, deselect **Allow Access to Deep Security Manager User Interface**.
1. On the **Computer Rights** tab, select either **All Computers** or **Selected Computers**, ensuring that only the greyed-out **View** right (under **Allow Users to**) is selected.
1. On the **Policy Rights** tab, select **Selected Policies**. Verify that no policies are selected. (The role does not grant rights for any policies.)
1. On the **User Rights** tab, select **Change own password and contact information only**.
1. On the **Other Rights* tab, verify that the default options remain, with only **View-Only** and **Hide** permissions.
1. Go to **Administration > User Manager > Users**.
1. Click **New**. Create a new user with a unique, meaningful name.
1. Select the role that you created in the previous section.

### Configure AWS Lambda

Configure these:

- Handler: RespondToAmazonGuardDutyViaDeepSecurity.lambda_handler
- Role: Basic Lambda invoke is required. Consider adding [AWS X-Ray permissions](http://docs.aws.amazon.com/xray/latest/devguide/xray-permissions.html) for better visibility
- (Advanced Settings) Memory: 128 MB
- (Advanced Settings) Timeout: 5m 0s

#### AWS Lambda Function Environment Variables

AWS Lambda now encrypts environment variables by default using a service level key. If you want to, you can override this choice and use a specific key managed by KMS. The combination of encrypted-by-default and a role-based access control (RBAC) strategy in Deep Security may be sufficient to address most threat models for most risk tolerance levels. If you want to use a specific key under KMS, please follow [the instructions](http://docs.aws.amazon.com/lambda/latest/dg/tutorial-env_console.html) in the AWS Lambda documentation.

<table>
<tr>
  <th>Environment Variable</th>
  <th>Expected Value Type</th>
  <th>Description</th>
</tr>
<tr>
  <td>dsUsername</td>
  <td>string</td>
  <td>The username of the Deep Security account to use for querying anti-malware status</td>
</tr>
<tr>
  <td>dsPassword</td>
  <td>string</td>
  <td>The password for the Deep Security account to use for querying anti-malware status. This password is readable by any identity that can access the AWS Lambda function. Use only the bare minimum permissions within Deep Security (see note below)</td>
</tr>
<tr>
  <td>dsTenant</td>
  <td>string</td>
  <td><i>Optional as long as dsHostname is specified</i>. Indicates which tenant to sign in to within Deep Security</td>
</tr>
<tr>
  <td>dsHostname</td>
  <td>string</td>
  <td><i>Optional as long as dsTenant is specified</i>. Defaults to Deep Security as a Service. Indicates which Deep Security manager the rule should sign in to</td>
</tr>
<tr>
  <td>dsPort</td>
  <td>int</td>
  <td><i>Optional</i>. Defaults to 443. Indicates the port to connect to the Deep Security manager on</td>
</tr>
<tr>
  <td>dsIgnoreSslValidation</td>
  <td>int (0 or 1)</td>
  <td><i>Optional</i>. 0 for false, 1 for true. Use only when connecting to a Deep Security manager that is using a self-signed SSL certificate</td>
</tr>
<tr>
	<td>slackURL</td>
	<td>string</td>
	<td><i>Optional</i>. The incoming webhook URL for the Slack team and channel you would like to send updates and findings to. These messages include contextual information as well as details on the actions taken as a result of the finding</td>
</tr>
<tr>
	<td>enableModules</td>
	<td>int (0 or 1)</td>
  <td><i>Optional</i>. 0 for false, 1 for true. When true, the function will enable the required modules for specific actions (e.g., enable anti-malware in cases where a malware scan is warranted)</td>
</tr>
</table>

#### SSL Certificate Validation

If the Deep Security Manager you're connecting to was installed via software in AWS Marketplace, might be using the default, self-signed SSL certificate. By default, Python checks the certificate for validity. Validation will fail for self-signed certificates.

If you are using self-signed certificates, please use the ```dsIgnoreSslValidation``` environment variable.

When you use this variable, you're telling Python to ignore any certificate warnings. These warnings should be due to the self-signed certificate but *could* be for other reasons. It is strongly recommended that you have alternative mitigations in place to secure your Deep Security Manager. 

When the flag is set, you'll see this warning in the logs:

```bash
***********************************************************************
* IGNORING SSL CERTIFICATE VALIDATION
* ===================================
* You have requested to ignore SSL certificate validation. This is a less secure method 
* of connecting to a Deep Security Manager (DSM). Please ensure that you have other 
* mitigations and security controls in place (like restricting IP space that can access 
* the DSM, implementing least privilege for the Deep Security user/role accessing the 
* API, etc).
*
* During script execution, you'll see a number of "InsecureRequestWarning" messages. 
* These are to be expected when operating without validation. 
***********************************************************************
```

And during execution you may see lines similar to;

```python
.../requests/packages/urllib3/connectionpool.py:789: InsecureRequestWarning: Unverified HTTPS request is being made. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.org/en/latest/security.html
```

These are expected warnings. Can you tell that we (and the Python core teams) are trying to tell you something? If you're interesting in using a valid SSL certificate, you can get one for free from [Let's Encrypt](https://letsencrypt.org), [AWS themselves](https://aws.amazon.com/certificate-manager/) (if your Deep Security Manager is behind an ELB), or explore commercial options (like the [one from Trend Micro](http://www.trendmicro.com/us/enterprise/cloud-solutions/deep-security/ssl-certificates/)).

## Test

The integration is triggered when Amazon GuardDuty generates a finding. It can be useful to force the generation of a finding. The simplest of these is a port scan. Run the following ```nmap``` command to trigger a finding.

```nnamp -sX DESTINATION_IP```

A faster feedback loop is to use the set of sample events included in the ```sample-events``` folder in this repo. Simply add these to AWS Lambda was test events and run them against the integration function. This will test the workflow on demand.

## Support

This is an Open Source community project. Project contributors may be able to help, 
depending on their time and availability. Please be specific about what you're 
trying to do, your system, and steps to reproduce the problem.

For bug reports or feature requests, please 
[open an issue](../issues). 
You are welcome to [contribute](#contribute).

Official support from Trend Micro is not available. Individual contributors may be 
Trend Micro employees, but are not official support.

## Contribute

We accept contributions from the community. To submit changes:

1. Fork this repository.
1. Create a new feature branch.
1. Make your changes.
1. Submit a pull request with an explanation of your changes or additions.

We will review and work with you to release the code.
